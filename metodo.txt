drop table clientes cascade constraints;
drop table abonos   cascade constraints;
drop table eventos  cascade constraints;
drop table reservas	cascade constraints;

drop sequence seq_abonos;
drop sequence seq_eventos;
drop sequence seq_reservas;


-- Creación de tablas y secuencias

create table clientes(
	NIF	varchar(9) primary key,
	nombre	varchar(20) not null,
	ape1	varchar(20) not null,
	ape2	varchar(20) not null
);


create sequence seq_abonos;

create table abonos(
	id_abono	integer primary key,
	cliente  	varchar(9) references clientes,
	saldo	    integer not null check (saldo>=0)
    );

create sequence seq_eventos;

create table eventos(
	id_evento	integer  primary key,
	nombre_evento		varchar(20),
    fecha       date not null,
	asientos_disponibles	integer  not null
);

create sequence seq_reservas;

create table reservas(
	id_reserva	integer primary key,
	cliente  	varchar(9) references clientes,
    evento      integer references eventos,
	abono       integer references abonos,
	fecha	date not null
);


	
-- Procedimiento a implementar para realizar la reserva
create or replace procedure reservar_evento( arg_NIF_cliente varchar,
 arg_nombre_evento varchar, arg_fecha date) is
 
 --Declaración de excepciones
 EVENTO_FINALIZADO      exception;
 PRAGMA EXCEPTION_INIT(EVENTO_FINALIZADO, -20001);
 
 EVENTO_INEXISTENTE    exception;
 PRAGMA EXCEPTION_INIT(EVENTO_INEXISTENTE, -20003);
 
 CLIENTE_INEXISTENTE    exception;
 PRAGMA EXCEPTION_INIT(CLIENTE_INEXISTENTE, -20002);
 
 SIN_SALDO   exception;
 PRAGMA EXCEPTION_INIT(SIN_SALDO, -20004);
 
 fecha_evento date;
 NIF_cliente varchar;
 saldo_abono_cliente integer;
 abono_cliente integer;
 
begin 
 
 begin
  SELECT fecha into fecha_evento
  FROM eventos
  WHERE nombre_evento = arg_nombre_evento;
  
  SELECT NIF into NIF_cliente
  FROM clientes
  WHERE NIF = arg_NIF_cliente;  
    
  SELECT saldo into saldo_abono_cliente
  FROM abonos
  WHERE cliente = NIF_cliente; 
  
  /*Excepcion 1*/
  if fecha_evento < arg_fecha then 
    raise EVENTO_FINALIZADO;
    end if;
  
  /*Excepcion 2*/
  if fecha_evento is null then 
    raise EVENTO_INEXISTENTE;
    end if;
    
  /*Excepcion 3*/
  if NIF_cliente is null then 
    raise CLIENTE_INEXISTENTE;
    end if;
    
  /*Excepcion 4*/
  if saldo_abono_cliente <= 0 then 
    raise SIN_SALDO;
    end if; 
  
  SELECT id_abono into abono_cliente
  FROM abonos
  WHERE cliente = NIF_cliente; 
  
  UPDATE abonos SET saldo=saldo-1
  WHERE cliente = NIF_cliente;
  
  UPDATE eventos SET asientos_disponibles=asientos_disponibles-1
  WHERE nombre_evento = arg_nombre_evento;
  
  INSERT INTO reservas VALUES(seq_reservas.nextval, NIF_cliente, arg_nombre_evento, abono_cliente, fecha_evento);
  
  exception
  when EVENTO_FINALIZADO then
    rollback;
    raise_application_error(-20001,'No se pueden reservar eventos pasados.');
    
  when EVENTO_INEXISTENTE then
    rollback;
    raise_application_error(-20003,'El evento '||arg_nombre_evento||' no existe.');
    
  when CLIENTE_INEXISTENTE then
    rollback;
    raise_application_error(-20002,'Cliente inexistente.');
        
  when SIN_SALDO then
    rollback;
    raise_application_error(-20004,'Saldo en abono insuficiente');
  end;
  
end;
/


------ Deja aquí tus respuestas a las preguntas del enunciado:
-- * P4.1
-- Sigue siendo fiable puesto que todas las acciones del paso 3 se han llevado a cabo,ya que no
-- ha saltado ninguna excepción en el paso 2. De haber saltado una excepción, habría sido atrapada
-- en el bloque "exception".
-- * P4.2
-- Esto ocurriría en caso de que otro proceso realizase una reserva entre la comprobación del paso 2 y
-- la ejecución del paso 3 que redujese el saldo o las plazas del evento.
-- * P4.3
-- Se usa una estrategia de programación defensiva, la cual previene errores realizando comprobaciones
-- de forma previa a cualquier acción.
-- * P4.4
-- Se hacen las comprobaciones antes de realizar cambios en la base de datos.
-- * P4.5
-- Se podría realizar de forma agresiva en vez de defensiva.


create or replace
procedure reset_seq( p_seq_name varchar )
is
    l_val number;
begin
    execute immediate
    'select ' || p_seq_name || '.nextval from dual' INTO l_val;

    execute immediate
    'alter sequence ' || p_seq_name || ' increment by -' || l_val || 
                                                          ' minvalue 0';
    execute immediate
    'select ' || p_seq_name || '.nextval from dual' INTO l_val;

    execute immediate
    'alter sequence ' || p_seq_name || ' increment by 1 minvalue 0';

end;
/


create or replace procedure inicializa_test is
begin
  reset_seq( 'seq_abonos' );
  reset_seq( 'seq_eventos' );
  reset_seq( 'seq_reservas' );
        
  
    delete from reservas;
    delete from eventos;
    delete from abonos;
    delete from clientes;
    
       
		
    insert into clientes values ('12345678A', 'Pepe', 'Perez', 'Porras');
    insert into clientes values ('11111111B', 'Beatriz', 'Barbosa', 'Bernardez');
    
    insert into abonos values (seq_abonos.nextval, '12345678A',10);
    insert into abonos values (seq_abonos.nextval, '11111111B',0);
    
    insert into eventos values ( seq_eventos.nextval, 'concierto_la_moda', date '2024-6-27', 200);
    insert into eventos values ( seq_eventos.nextval, 'teatro_impro', date '2024-7-1', 50);

    commit;
end;
/

exec inicializa_test;

-- Completa el test

create or replace procedure test_reserva_evento is
begin
	 
  --caso 1 Reserva correcta, se realiza
  begin
    inicializa_test;
    reservar_evento('12345678A','teatro_impro','2024-7-1');
  exception
    when others then
      if sqlcode = 0 then
        dbms_output.put_line('Detecta OK reserva: '||sqlerrm);
      else
        dbms_output.put_line('Mal no detecta reserva: '||sqlerrm);
      end if;
  end;
  
  
  --caso 2 Evento pasado
  begin
    inicializa_test;
    reservar_evento('12345678A','teatro_impro','2023-8-1');
    dbms_output.put_line('Mal no detecta EVENTO_FINALIZADO');
  exception
    when others then
      if sqlcode = -20001 then
        dbms_output.put_line('Detecta OK EVENTO_FINALIZADO: '||sqlerrm);
      else
        dbms_output.put_line('Mal no detecta EVENTO_FINALIZADO: '||sqlerrm);
      end if;
  end;
  
  --caso 3 Evento inexistente
  begin
    inicializa_test;
    reservar_evento('12345678A','el_rey_leon','2024-7-1');
    dbms_output.put_line('Mal no detecta EVENTO_INEXISTENTE');
  exception
    when others then
      if sqlcode = -20003 then
        dbms_output.put_line('Detecta OK EVENTO_INEXISTENTE: '||sqlerrm);
      else
        dbms_output.put_line('Mal no detecta EVENTO_INEXISTENTE: '||sqlerrm);
      end if;
  end;
  

  --caso 4 Cliente inexistente  
  begin
    inicializa_test;
    reservar_evento('12345678B','teatro_impro','2024-7-1');
    dbms_output.put_line('Mal no detecta CLIENTE_INEXISTENTE');
  exception
    when others then
      if sqlcode = -20002 then
        dbms_output.put_line('Detecta OK CLIENTE_INEXISTENTE: '||sqlerrm);
      else
        dbms_output.put_line('Mal no detecta CLIENTE_INEXISTENTE: '||sqlerrm);
      end if;
  end;
  
  --caso 5 El cliente no tiene saldo suficiente
  begin
    inicializa_test;
    reservar_evento('11111111B','teatro_impro','2024-7-1');
    dbms_output.put_line('Mal no detecta SIN_SALDO');
  exception
    when others then
      if sqlcode = -20004 then
        dbms_output.put_line('Detecta OK SIN_SALDO: '||sqlerrm);
      else
        dbms_output.put_line('Mal no detecta SIN_SALDO: '||sqlerrm);
      end if;
  end;

  
end;
/


set serveroutput on;
exec test_reserva_evento;